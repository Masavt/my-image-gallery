<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forbidden Stories - Next Generation Immersive Experience</title>
    <meta name="description" content="五感で体験する次世代インタラクティブストーリーエンジン">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Framer Motion (simplified) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@200;400;700&display=swap');
        
        :root {
            --primary: #8B0000;
            --secondary: #DC143C;
            --dark: #0a0a0a;
            --light: #fafafa;
            --accent: #ff1744;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: var(--dark);
            color: var(--light);
            font-family: 'Noto Serif JP', serif;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Cinematic Effects */
        .cinematic-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            background: radial-gradient(circle, transparent 50%, rgba(0,0,0,0.4) 100%);
        }
        
        .grain {
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj4KPGZpbHRlciBpZD0ibm9pc2UiPgo8ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iMC45IiBudW1PY3RhdmVzPSI0IiAvPgo8L2ZpbHRlcj4KPHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbHRlcj0idXJsKCNub2lzZSkiIG9wYWNpdHk9IjAuMDIiLz4KPC9zdmc+');
            opacity: 0.05;
            pointer-events: none;
            animation: grain 8s steps(10) infinite;
        }
        
        @keyframes grain {
            0%, 100% { transform: translate(0, 0) }
            10% { transform: translate(-5%, -10%) }
            30% { transform: translate(3%, 15%) }
            50% { transform: translate(12%, 9%) }
            70% { transform: translate(9%, 4%) }
            90% { transform: translate(-1%, 7%) }
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        .fade-in {
            animation: fadeIn 1s ease-out forwards;
        }
        
        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* DNA Diagnostic */
        .dna-card {
            background: linear-gradient(135deg, rgba(139,0,0,0.2) 0%, rgba(0,0,0,0.8) 100%);
            border: 1px solid var(--primary);
            border-radius: 20px;
            padding: 30px;
            margin: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .dna-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .dna-card:hover::before {
            opacity: 0.1;
        }
        
        .dna-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(220,20,60,0.3);
        }
        
        /* Story Scene */
        .story-scene {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            opacity: 0;
            transition: opacity 1s ease;
        }
        
        .story-scene.active {
            opacity: 1;
        }
        
        .scene-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(0.7) contrast(1.2);
            z-index: -1;
        }
        
        .scene-text {
            max-width: 800px;
            padding: 40px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            font-size: 1.2em;
            line-height: 2;
            letter-spacing: 0.05em;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }
        
        /* Choice Buttons */
        .choice-container {
            display: flex;
            gap: 30px;
            margin-top: 40px;
            justify-content: center;
        }
        
        .choice-btn {
            padding: 15px 40px;
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--light);
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--primary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
        }
        
        .choice-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .choice-btn:hover {
            color: white;
            transform: scale(1.05);
        }
        
        .choice-btn span {
            position: relative;
            z-index: 1;
        }
        
        /* Intensity Meter */
        .intensity-meter {
            position: fixed;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 300px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .intensity-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, var(--primary), var(--accent));
            transition: height 0.5s ease;
        }
        
        /* Sound Visualizer */
        .sound-visualizer {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 3px;
            height: 50px;
            align-items: flex-end;
        }
        
        .sound-bar {
            width: 3px;
            background: var(--accent);
            animation: soundWave 1s ease-in-out infinite;
        }
        
        @keyframes soundWave {
            0%, 100% { height: 10px; }
            50% { height: 40px; }
        }
        
        .sound-bar:nth-child(2) { animation-delay: 0.1s; }
        .sound-bar:nth-child(3) { animation-delay: 0.2s; }
        .sound-bar:nth-child(4) { animation-delay: 0.3s; }
        .sound-bar:nth-child(5) { animation-delay: 0.4s; }
        
        /* Fetish Matrix */
        .fetish-matrix {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 40px 0;
        }
        
        .fetish-axis {
            text-align: center;
        }
        
        .fetish-slider {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            appearance: none;
            outline: none;
            margin: 20px 0;
        }
        
        .fetish-slider::-webkit-slider-thumb {
            appearance: none;
            width: 25px;
            height: 25px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 20px var(--accent);
        }
        
        /* Loading State */
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .dna-helix {
            width: 100px;
            height: 100px;
            position: relative;
            animation: rotate 2s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .helix-strand {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid var(--accent);
            border-radius: 50%;
            opacity: 0.5;
        }
        
        .helix-strand:nth-child(2) {
            transform: rotateY(60deg);
        }
        
        .helix-strand:nth-child(3) {
            transform: rotateY(120deg);
        }
        
        /* Haptic Feedback Indicator */
        .haptic-indicator {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 60px;
            height: 60px;
            border: 2px solid var(--accent);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .haptic-indicator.active {
            opacity: 1;
            animation: hapticPulse 0.5s ease;
        }
        
        @keyframes hapticPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Cinematic Overlays -->
    <div class="cinematic-overlay"></div>
    <div class="grain"></div>
    
    <!-- Sound Visualizer -->
    <div class="sound-visualizer" id="soundVisualizer" style="display: none;">
        <div class="sound-bar"></div>
        <div class="sound-bar"></div>
        <div class="sound-bar"></div>
        <div class="sound-bar"></div>
        <div class="sound-bar"></div>
    </div>
    
    <!-- Intensity Meter -->
    <div class="intensity-meter" id="intensityMeter" style="display: none;">
        <div class="intensity-fill" id="intensityFill" style="height: 20%;"></div>
    </div>
    
    <!-- Haptic Indicator -->
    <div class="haptic-indicator" id="hapticIndicator">
        <svg width="30" height="30" viewBox="0 0 30 30">
            <circle cx="15" cy="15" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
            <circle cx="15" cy="15" r="5" fill="currentColor"/>
        </svg>
    </div>
    
    <!-- Loading State -->
    <div class="loading-container" id="loadingContainer">
        <div class="dna-helix">
            <div class="helix-strand"></div>
            <div class="helix-strand"></div>
            <div class="helix-strand"></div>
        </div>
        <h2 class="mt-8 text-2xl">Analyzing your desires...</h2>
    </div>
    
    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8" id="mainContainer" style="display: none;">
        
        <!-- Phase 1: DNA Diagnostic -->
        <div id="dnaDiagnostic" class="min-h-screen flex flex-col justify-center">
            <h1 class="text-5xl font-bold text-center mb-12 fade-in">
                Fetish DNA Diagnostic
            </h1>
            <p class="text-xl text-center mb-12 opacity-80 fade-in" style="animation-delay: 0.2s;">
                10の質問であなたの深層欲求を解析します
            </p>
            
            <div class="fetish-matrix">
                <div class="fetish-axis fade-in" style="animation-delay: 0.3s;">
                    <h3 class="text-lg mb-4">Power Balance</h3>
                    <input type="range" class="fetish-slider" id="powerBalance" min="0" max="100" value="50">
                    <div class="flex justify-between text-sm opacity-60">
                        <span>対等</span>
                        <span>支配</span>
                    </div>
                </div>
                
                <div class="fetish-axis fade-in" style="animation-delay: 0.4s;">
                    <h3 class="text-lg mb-4">Environmental Thrill</h3>
                    <input type="range" class="fetish-slider" id="environmentThrill" min="0" max="100" value="50">
                    <div class="flex justify-between text-sm opacity-60">
                        <span>密室</span>
                        <span>公共</span>
                    </div>
                </div>
                
                <div class="fetish-axis fade-in" style="animation-delay: 0.5s;">
                    <h3 class="text-lg mb-4">Sensory Intensity</h3>
                    <input type="range" class="fetish-slider" id="sensoryIntensity" min="0" max="100" value="50">
                    <div class="flex justify-between text-sm opacity-60">
                        <span>ソフト</span>
                        <span>ハード</span>
                    </div>
                </div>
                
                <div class="fetish-axis fade-in" style="animation-delay: 0.6s;">
                    <h3 class="text-lg mb-4">Body Focus</h3>
                    <select id="bodyFocus" class="w-full p-3 bg-black/50 border border-red-900 rounded-lg">
                        <option value="hands">手・指</option>
                        <option value="feet">足・脚</option>
                        <option value="neck">首筋・耳裏</option>
                        <option value="mixed">ミックス</option>
                    </select>
                </div>
                
                <div class="fetish-axis fade-in" style="animation-delay: 0.7s;">
                    <h3 class="text-lg mb-4">Psychological Theme</h3>
                    <select id="psychTheme" class="w-full p-3 bg-black/50 border border-red-900 rounded-lg">
                        <option value="forbidden">禁断</option>
                        <option value="transformation">変身</option>
                        <option value="guilt">罪悪感＆浄化</option>
                    </select>
                </div>
                
                <div class="fetish-axis fade-in" style="animation-delay: 0.8s;">
                    <h3 class="text-lg mb-4">Narrative Tone</h3>
                    <select id="narrativeTone" class="w-full p-3 bg-black/50 border border-red-900 rounded-lg">
                        <option value="whisper">囁き</option>
                        <option value="poetic">詩的</option>
                        <option value="primal">獣性</option>
                    </select>
                </div>
            </div>
            
            <button onclick="startDNAAnalysis()" class="mx-auto mt-12 px-12 py-4 bg-gradient-to-r from-red-900 to-red-600 rounded-full text-xl font-bold hover:scale-105 transition-transform fade-in" style="animation-delay: 0.9s;">
                診断を開始
            </button>
        </div>
        
        <!-- Phase 2: Scenario Selection -->
        <div id="scenarioSelection" class="min-h-screen flex flex-col justify-center" style="display: none;">
            <h2 class="text-4xl font-bold text-center mb-12">
                Your Fetish DNA Results
            </h2>
            
            <div id="dnaResults" class="max-w-2xl mx-auto mb-12 p-8 bg-black/50 rounded-2xl border border-red-900">
                <!-- DNA results will be inserted here -->
            </div>
            
            <h3 class="text-2xl text-center mb-8">推奨シナリオ</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                <div class="dna-card" onclick="selectScenario('preset1')">
                    <h4 class="text-xl font-bold mb-2">Midnight Confession</h4>
                    <p class="opacity-80">深夜のオフィスで起こる禁断の告白</p>
                    <div class="mt-4 text-sm opacity-60">
                        Power: 70% | Thrill: 40% | Sensory: 60%
                    </div>
                </div>
                
                <div class="dna-card" onclick="selectScenario('preset2')">
                    <h4 class="text-xl font-bold mb-2">Transformation Ritual</h4>
                    <p class="opacity-80">新しい自分への変身の儀式</p>
                    <div class="mt-4 text-sm opacity-60">
                        Power: 30% | Thrill: 80% | Sensory: 90%
                    </div>
                </div>
                
                <div class="dna-card" onclick="selectScenario('custom')">
                    <h4 class="text-xl font-bold mb-2">Custom Creation</h4>
                    <p class="opacity-80">あなただけのオリジナルストーリー</p>
                    <div class="mt-4 text-sm opacity-60">
                        完全カスタマイズ
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Phase 3: Story Experience -->
        <div id="storyExperience" style="display: none;">
            <!-- Dynamic story scenes will be inserted here -->
        </div>
        
        <!-- Phase 4: Finish Mode -->
        <div id="finishMode" class="min-h-screen flex flex-col justify-center" style="display: none;">
            <h2 class="text-4xl font-bold text-center mb-12">
                Experience Complete
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                <div class="dna-card" onclick="exportAs('text')">
                    <h4 class="text-xl font-bold mb-2">📖 Save as Text</h4>
                    <p class="opacity-80">テキスト形式で保存</p>
                </div>
                
                <div class="dna-card" onclick="exportAs('movie')">
                    <h4 class="text-xl font-bold mb-2">🎬 Create Movie</h4>
                    <p class="opacity-80">ムービー形式で出力</p>
                </div>
                
                <div class="dna-card" onclick="exportAs('audio')">
                    <h4 class="text-xl font-bold mb-2">🎧 Audio Drama</h4>
                    <p class="opacity-80">音声ドラマ化</p>
                </div>
            </div>
            
            <div class="mt-12 text-center">
                <h3 class="text-2xl mb-4">Next Recommendation</h3>
                <p id="nextRecommendation" class="opacity-80">
                    <!-- AI recommendation will be inserted here -->
                </p>
                <button onclick="startNewStory()" class="mt-6 px-8 py-3 bg-gradient-to-r from-red-900 to-red-600 rounded-full hover:scale-105 transition-transform">
                    New Story
                </button>
            </div>
        </div>
    </div>

    <script>
        // Core State Management
        const StoryEngine = {
            state: {
                phase: 'loading',
                dnaProfile: {},
                currentScenario: null,
                currentScene: 0,
                intensity: 0,
                choices: [],
                generatedContent: [],
                audioContext: null,
                hapticEnabled: false
            },
            
            // Initialize
            init() {
                setTimeout(() => {
                    document.getElementById('loadingContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    this.setState('phase', 'dna');
                    this.initAudio();
                    this.initHaptic();
                }, 2000);
            },
            
            // State Management
            setState(key, value) {
                this.state[key] = value;
                this.render();
            },
            
            // Audio System
            initAudio() {
                if (window.AudioContext) {
                    this.state.audioContext = new AudioContext();
                    this.createBinauralBeats();
                }
            },
            
            createBinauralBeats() {
                if (!this.state.audioContext) return;
                
                const ctx = this.state.audioContext;
                const leftOsc = ctx.createOscillator();
                const rightOsc = ctx.createOscillator();
                const leftGain = ctx.createGain();
                const rightGain = ctx.createGain();
                const merger = ctx.createChannelMerger(2);
                
                leftOsc.frequency.value = 440;
                rightOsc.frequency.value = 444; // 4Hz difference for theta waves
                
                leftGain.gain.value = 0.05;
                rightGain.gain.value = 0.05;
                
                leftOsc.connect(leftGain);
                rightOsc.connect(rightGain);
                leftGain.connect(merger, 0, 0);
                rightGain.connect(merger, 0, 1);
                merger.connect(ctx.destination);
                
                // Store for later control
                this.binauralBeats = { leftOsc, rightOsc, leftGain, rightGain };
            },
            
            // Haptic System
            initHaptic() {
                if ('vibrate' in navigator) {
                    this.state.hapticEnabled = true;
                }
            },
            
            triggerHaptic(pattern) {
                if (!this.state.hapticEnabled) return;
                
                const patterns = {
                    heartbeat: [100, 200, 100, 200, 100, 1000],
                    pulse: [50, 100, 50],
                    intense: [200, 100, 200, 100, 200],
                    climax: [500, 200, 500, 200, 1000]
                };
                
                navigator.vibrate(patterns[pattern] || pattern);
                
                // Visual feedback
                const indicator = document.getElementById('hapticIndicator');
                indicator.classList.add('active');
                setTimeout(() => indicator.classList.remove('active'), 500);
            },
            
            // Render System
            render() {
                const { phase } = this.state;
                
                // Hide all phases
                ['dnaDiagnostic', 'scenarioSelection', 'storyExperience', 'finishMode'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
                
                // Show current phase
                if (phase === 'dna') {
                    document.getElementById('dnaDiagnostic').style.display = 'flex';
                } else if (phase === 'scenario') {
                    document.getElementById('scenarioSelection').style.display = 'flex';
                    this.renderDNAResults();
                } else if (phase === 'story') {
                    document.getElementById('storyExperience').style.display = 'block';
                    document.getElementById('soundVisualizer').style.display = 'flex';
                    document.getElementById('intensityMeter').style.display = 'block';
                    this.renderStoryScene();
                } else if (phase === 'finish') {
                    document.getElementById('finishMode').style.display = 'flex';
                    this.renderRecommendation();
                }
            }
        };
        
        // DNA Analysis Functions
        function startDNAAnalysis() {
            const profile = {
                powerBalance: document.getElementById('powerBalance').value,
                environmentThrill: document.getElementById('environmentThrill').value,
                sensoryIntensity: document.getElementById('sensoryIntensity').value,
                bodyFocus: document.getElementById('bodyFocus').value,
                psychTheme: document.getElementById('psychTheme').value,
                narrativeTone: document.getElementById('narrativeTone').value
            };
            
            StoryEngine.setState('dnaProfile', profile);
            StoryEngine.setState('phase', 'scenario');
            
            // Trigger haptic feedback
            StoryEngine.triggerHaptic('pulse');
        }
        
        // Scenario Selection
        function selectScenario(type) {
            StoryEngine.setState('currentScenario', type);
            generateStoryContent(type);
        }
        
        // Story Generation System
        async function generateStoryContent(scenario) {
            // Show loading
            document.getElementById('loadingContainer').style.display = 'flex';
            
            // Simulate API call to GPT-4
            const storyData = await simulateStoryGeneration(scenario);
            
            StoryEngine.state.generatedContent = storyData;
            StoryEngine.setState('phase', 'story');
            
            document.getElementById('loadingContainer').style.display = 'none';
            
            // Start immersive experience
            if (StoryEngine.state.audioContext) {
                StoryEngine.binauralBeats.leftOsc.start();
                StoryEngine.binauralBeats.rightOsc.start();
            }
        }
        
        // Simulated Story Generation
        async function simulateStoryGeneration(scenario) {
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const { dnaProfile } = StoryEngine.state;
            
            // Generate based on DNA profile
            const scenes = [
                {
                    text: `深夜2時。オフィスビルの最上階。街の灯りが宝石のように瞬く中、あなたは一人残業していた。
                           突然、背後から忍び寄る気配。振り返ると、そこには...`,
                    image: 'https://images.unsplash.com/photo-1519608487953-e999c86e7455?w=1200',
                    mood: 'mysterious',
                    choices: ['振り返る', '無視する'],
                    haptic: 'heartbeat',
                    audio: { frequency: 440, volume: 0.1 }
                },
                {
                    text: `「待っていたよ」低い声が耳元で囁く。
                           その声には、昼間のオフィスでは決して聞くことのない、危険な響きが含まれていた。
                           あなたの身体が、本能的に反応する。`,
                    image: 'https://images.unsplash.com/photo-1516589178581-6cd7833ae3b2?w=1200',
                    mood: 'tension',
                    choices: ['近づく', '離れる'],
                    haptic: 'pulse',
                    audio: { frequency: 528, volume: 0.15 }
                },
                {
                    text: `月明かりが差し込む会議室。
                           テーブルの上に置かれた契約書。
                           「これにサインすれば、新しい世界が始まる」
                           ペンを持つ手が、微かに震えた。`,
                    image: 'https://images.unsplash.com/photo-1502716119720-b23a93e5fe1b?w=1200',
                    mood: 'climax',
                    choices: ['サインする', '拒否する'],
                    haptic: 'intense',
                    audio: { frequency: 639, volume: 0.2 }
                }
            ];
            
            // Adjust based on intensity
            const intensity = parseInt(dnaProfile.sensoryIntensity);
            scenes.forEach(scene => {
                if (intensity > 70) {
                    scene.text += '\n\n熱い吐息が首筋を撫でる。理性が、少しずつ溶けていく。';
                    scene.haptic = 'intense';
                }
            });
            
            return scenes;
        }
        
        // Story Rendering
        StoryEngine.renderStoryScene = function() {
            const scene = this.state.generatedContent[this.state.currentScene];
            if (!scene) return;
            
            const container = document.getElementById('storyExperience');
            container.innerHTML = `
                <div class="story-scene active">
                    <img src="${scene.image}" alt="Scene" class="scene-image">
                    <div class="scene-text">
                        ${scene.text.split('\n').map(p => `<p class="mb-4">${p}</p>`).join('')}
                    </div>
                    <div class="choice-container">
                        ${scene.choices.map((choice, i) => `
                            <button class="choice-btn" onclick="makeChoice(${i})">
                                <span>${choice}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Update intensity meter
            this.updateIntensity(scene.mood);
            
            // Trigger haptic
            this.triggerHaptic(scene.haptic);
            
            // Adjust audio
            if (this.binauralBeats && scene.audio) {
                this.binauralBeats.leftOsc.frequency.value = scene.audio.frequency;
                this.binauralBeats.rightOsc.frequency.value = scene.audio.frequency + 4;
                this.binauralBeats.leftGain.gain.value = scene.audio.volume;
                this.binauralBeats.rightGain.gain.value = scene.audio.volume;
            }
        };
        
        StoryEngine.updateIntensity = function(mood) {
            const intensityMap = {
                mysterious: 20,
                tension: 50,
                climax: 80,
                resolution: 30
            };
            
            const targetIntensity = intensityMap[mood] || 50;
            const currentIntensity = this.state.intensity;
            
            // Smooth transition
            const step = (targetIntensity - currentIntensity) / 10;
            let current = currentIntensity;
            
            const interval = setInterval(() => {
                current += step;
                if (Math.abs(current - targetIntensity) < 1) {
                    current = targetIntensity;
                    clearInterval(interval);
                }
                
                document.getElementById('intensityFill').style.height = `${current}%`;
                this.state.intensity = current;
            }, 50);
        };
        
        // Choice System
        function makeChoice(choiceIndex) {
            StoryEngine.state.choices.push({
                scene: StoryEngine.state.currentScene,
                choice: choiceIndex
            });
            
            StoryEngine.triggerHaptic('pulse');
            
            // Progress to next scene
            if (StoryEngine.state.currentScene < StoryEngine.state.generatedContent.length - 1) {
                StoryEngine.state.currentScene++;
                StoryEngine.renderStoryScene();
            } else {
                // Story complete
                StoryEngine.setState('phase', 'finish');
                
                // Stop audio
                if (StoryEngine.binauralBeats) {
                    StoryEngine.binauralBeats.leftOsc.stop();
                    StoryEngine.binauralBeats.rightOsc.stop();
                }
            }
        }
        
        // DNA Results Rendering
        StoryEngine.renderDNAResults = function() {
            const { dnaProfile } = this.state;
            const resultsDiv = document.getElementById('dnaResults');
            
            const fetishScore = {
                dominant: dnaProfile.powerBalance > 70,
                exhibitionist: dnaProfile.environmentThrill > 70,
                sensual: dnaProfile.sensoryIntensity > 70,
                focused: dnaProfile.bodyFocus,
                theme: dnaProfile.psychTheme,
                tone: dnaProfile.narrativeTone
            };
            
            resultsDiv.innerHTML = `
                <h3 class="text-2xl font-bold mb-4">Your Fetish DNA</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="font-bold">Power Dynamic:</p>
                        <p>${fetishScore.dominant ? 'Dominant Tendency' : 'Balanced/Submissive'}</p>
                    </div>
                    <div>
                        <p class="font-bold">Thrill Level:</p>
                        <p>${fetishScore.exhibitionist ? 'High Risk Taker' : 'Privacy Focused'}</p>
                    </div>
                    <div>
                        <p class="font-bold">Sensory Profile:</p>
                        <p>${fetishScore.sensual ? 'Intense Sensations' : 'Gentle Touch'}</p>
                    </div>
                    <div>
                        <p class="font-bold">Focus Area:</p>
                        <p>${fetishScore.focused}</p>
                    </div>
                </div>
                <div class="mt-4 p-4 bg-red-900/20 rounded-lg">
                    <p class="text-sm opacity-80">
                        Based on your profile, we recommend scenarios with 
                        ${fetishScore.theme} themes delivered in a ${fetishScore.tone} narrative style.
                    </p>
                </div>
            `;
        };
        
        // Recommendation System
        StoryEngine.renderRecommendation = function() {
            const { dnaProfile, choices } = this.state;
            
            // Analyze choices to refine recommendations
            const choicePattern = choices.map(c => c.choice).join('');
            
            let recommendation = '';
            if (choicePattern.includes('0')) {
                recommendation = 'Your choices indicate a preference for direct confrontation. Next time, try "The Predator\'s Game".';
            } else {
                recommendation = 'You tend toward careful exploration. "The Slow Burn" scenario might captivate you.';
            }
            
            document.getElementById('nextRecommendation').textContent = recommendation;
        };
        
        // Export Functions
        function exportAs(format) {
            const { generatedContent } = StoryEngine.state;
            
            if (format === 'text') {
                const text = generatedContent.map(scene => scene.text).join('\n\n---\n\n');
                downloadText(text, 'forbidden-story.txt');
            } else if (format === 'movie') {
                alert('Movie generation requires additional processing. Feature coming soon!');
            } else if (format === 'audio') {
                generateAudioDrama();
            }
        }
        
        function downloadText(text, filename) {
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }
        
        async function generateAudioDrama() {
            // Simulate TTS API call
            alert('Generating audio drama with binaural effects...');
            
            // In real implementation:
            // 1. Send text to ElevenLabs API
            // 2. Apply binaural processing
            // 3. Mix with ambient sounds
            // 4. Export as audio file
        }
        
        function startNewStory() {
            StoryEngine.state.currentScene = 0;
            StoryEngine.state.choices = [];
            StoryEngine.setState('phase', 'dna');
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            StoryEngine.init();
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === '1' && StoryEngine.state.phase === 'story') {
                makeChoice(0);
            } else if (e.key === '2' && StoryEngine.state.phase === 'story') {
                makeChoice(1);
            }
        });
        
        // Advanced Features
        class FetishLexicon {
            constructor() {
                this.synonyms = {
                    touch: ['撫でる', '触れる', 'なぞる', '這わせる', '辿る'],
                    feel: ['感じる', '覚える', '震える', '疼く', '痺れる'],
                    desire: ['欲望', '渇望', '衝動', '本能', '飢え']
                };
            }
            
            diversify(text) {
                let result = text;
                Object.entries(this.synonyms).forEach(([key, values]) => {
                    const regex = new RegExp(key, 'gi');
                    result = result.replace(regex, () => 
                        values[Math.floor(Math.random() * values.length)]
                    );
                });
                return result;
            }
        }
        
        // Real-time image generation simulation
        class ImageGenerator {
            async generate(prompt, style) {
                // In production: Call Stable Diffusion API
                const mockImages = {
                    mysterious: 'https://images.unsplash.com/photo-1519608487953-e999c86e7455?w=1200',
                    intimate: 'https://images.unsplash.com/photo-1516589178581-6cd7833ae3b2?w=1200',
                    tension: 'https://images.unsplash.com/photo-1502716119720-b23a93e5fe1b?w=1200'
                };
                
                return mockImages[style] || mockImages.mysterious;
            }
        }
        
        // Performance monitoring
        class PerformanceMonitor {
            constructor() {
                this.metrics = {
                    sessionStart: Date.now(),
                    interactions: [],
                    intensityPeaks: []
                };
            }
            
            track(event, data) {
                this.metrics.interactions.push({
                    timestamp: Date.now() - this.metrics.sessionStart,
                    event,
                    data
                });
                
                // Send to analytics in production
                console.log('Tracking:', event, data);
            }
        }
        
        const perfMonitor = new PerformanceMonitor();
        
        // WebGL Effects (simplified)
        function applyPostProcessing(imageElement) {
            // In production: Use Three.js or custom WebGL
            imageElement.style.filter = `
                contrast(1.2) 
                brightness(0.9) 
                saturate(1.1)
                blur(0.3px)
            `;
        }
        
        // Biometric simulation (future feature)
        class BiometricReader {
            constructor() {
                this.heartRate = 70;
                this.skinConductance = 0.5;
            }
            
            simulate(intensity) {
                this.heartRate = 70 + (intensity * 0.5);
                this.skinConductance = 0.5 + (intensity * 0.01);
                
                return {
                    hr: this.heartRate,
                    sc: this.skinConductance
                };
            }
        }
        
        // Initialize subsystems
        const lexicon = new FetishLexicon();
        const imageGen = new ImageGenerator();
        const biometric = new BiometricReader();
        
        console.log('Forbidden Stories Engine v2.0 initialized');
        console.log('All systems operational');
    </script>
</body>
</html>
